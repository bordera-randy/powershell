name: Docs (MkDocs Material)

on:
  push:
    branches: [ main ]
    paths:
      - "docs-site/**"
      - "modules/**"
      - "docs/**"
      - "build.ps1"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install docs dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r docs-site/requirements.txt

      - name: Build PlatyPS help (best effort)
        shell: pwsh
        run: |
          try {
            Install-Module PlatyPS -Scope CurrentUser -Force -ErrorAction Stop
            Import-Module ./modules/SysAdminTools/SysAdminTools.psd1 -Force
            New-MarkdownHelp -Module SysAdminTools -OutputFolder ./docs/help/SysAdminTools -Force
          } catch {
            Write-Host "PlatyPS step skipped or failed: $($_.Exception.Message)"
          }

      - name: Sync PlatyPS Markdown into docs site
        run: |
          mkdir -p docs-site/docs/commands
          if [ -d "docs/help/SysAdminTools" ]; then
            cp -f docs/help/SysAdminTools/*.md docs-site/docs/commands/ 2>/dev/null || true
          fi

      - name: Deploy MkDocs to GitHub Pages (gh-pages branch)
        working-directory: docs-site
        run: |
          mkdocs gh-deploy --force
